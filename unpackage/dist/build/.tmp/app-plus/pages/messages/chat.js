(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/messages/chat"],{"01e5":function(t,e,s){"use strict";s.r(e);var i=s("9828"),a=s.n(i);for(var n in i)"default"!==n&&function(t){s.d(e,t,function(){return i[t]})}(n);e["default"]=a.a},"0338":function(t,e,s){"use strict";s("83ff");var i=n(s("b0ce")),a=n(s("6b97"));function n(t){return t&&t.__esModule?t:{default:t}}Page((0,i.default)(a.default))},"2dd1":function(t,e,s){},4271:function(t,e,s){"use strict";var i=s("2dd1"),a=s.n(i);a.a},"6b97":function(t,e,s){"use strict";s.r(e);var i=s("8485"),a=s("01e5");for(var n in a)"default"!==n&&function(t){s.d(e,t,function(){return a[t]})}(n);s("4271"),s("b297");var o=s("2877"),r=Object(o["a"])(a["default"],i["a"],i["b"],!1,null,"4e610025",null);e["default"]=r.exports},8485:function(t,e,s){"use strict";var i=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("view",{staticClass:"chat_page"},[s("view",{staticClass:"main"},[s("scroll-view",{staticClass:"chat_box",style:{height:t.style.contentViewHeight+"px"},attrs:{"scroll-top":t.scrollTop,"scroll-y":"","scroll-with-animation":t.scrollAnimation,"scroll-into-view":t.scrollToView}},[t.msgList.length>0?s("view",{staticClass:"msg_list_wrap"},t._l(t.msgList,function(e,i){return s("view",{key:i,staticClass:"msg_list",attrs:{id:"msg"+e.id}},[s("text",{staticClass:"date"},[t._v(t._s(e.date))]),"user"===e.type?s("view",{staticClass:"msg_left"},[s("img",{staticClass:"avatar",attrs:{src:e.header?e.header:"/static/images/default_avatar.jpg"}}),""!==e.msg?s("view",{staticClass:"msg_box"},[s("view",{staticClass:"msg",domProps:{innerHTML:t._s(e.msg)}})]):t._e()]):t._e(),"me"===e.type?s("view",{staticClass:"msg_right"},[s("img",{staticClass:"avatar",attrs:{src:e.header?e.header:"/static/images/default_avatar.jpg"}}),""!==e.msg?s("view",{staticClass:"msg_box"},[s("view",{staticClass:"msg",domProps:{innerHTML:t._s(e.msg)}})]):t._e()]):t._e()])})):t._e()])],1),s("view",{staticClass:"send_box"},[s("view",{staticClass:"cur_msg"},[s("textarea",{directives:[{name:"model",rawName:"v-model",value:t.msg,expression:"msg"}],attrs:{"auto-height":"true",eventid:"a23a72a0-0"},domProps:{value:t.msg},on:{input:function(e){e.target.composing||(t.msg=e.target.value)}}})]),s("button",{staticClass:"send_btn",class:{dis_btn:""===t.msg},attrs:{eventid:"a23a72a0-1"},on:{tap:function(e){e.stopPropagation(),t.sendMsg(e)}}},[t._v("发送")])],1)])},a=[];s.d(e,"a",function(){return i}),s.d(e,"b",function(){return a})},9828:function(t,e,s){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=s("2f62"),a=(s("942f"),o(s("8534"))),n=s("3c10");function o(t){return t&&t.__esModule?t:{default:t}}function r(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{},i=Object.keys(s);"function"===typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(s).filter(function(t){return Object.getOwnPropertyDescriptor(s,t).enumerable}))),i.forEach(function(e){c(t,e,s[e])})}return t}function c(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}var l={data:function(){return{host:n.shortHttp,scrollTop:0,style:{pageHeight:0,contentViewHeight:0,footViewHeight:90,mitemHeight:0},msgList:[],msg:"",scrollToView:"",scrollAnimation:!1,meId:"",toId:"",meHead:"",userHead:"",historyLoading:!1}},onLoad:function(e){var s=JSON.parse(e.param),i=s.title;t.setNavigationBarTitle({title:i});var a=t.getStorageSync("dz_userInfo");this.toId=s.list_id,this.meId=a.userid,this.meHead=a.headImgurl?this.host+a.headImgurl:"",this.userHead=s.userpic?this.host+s.userpic:"";var n=t.getSystemInfoSync();this.style.pageHeight=n.windowHeight,this.style.contentViewHeight=n.windowHeight-t.getSystemInfoSync().screenWidth/750*100,this.getChatHistory(),this.$nextTick(function(){this.scrollTop=99999}),this.getMsg()},onShow:function(){},onBackPress:function(){this.getChatHistory()},computed:r({},(0,i.mapState)(["socketOpen","chatList","socketError","socketLoading","socketObj"])),methods:{sendMsg:function(){var t=this;if(""!==this.msg)if(this.socketOpen||this.socketLoading)if(this.socketLoading)a.default.layer("正在重连聊天室,请稍等");else{var e=this,s=e.getCurTime(),i=e.msgList.length;this.scrollAnimation=!0;var n={type:"one",content:e.msg,to_id:e.toId};e.socketObj.send({data:JSON.stringify(n),success:function(a){e.msgList.push({type:"me",header:e.meHead,id:i,msg:e.msg,date:s}),e.handleMsg(e.msgList[e.msgList.length-1]),t.msg=""},fail:function(t){a.default.layer("发送消息失败")},complete:function(t){}})}else a.default.layer("聊天室未响应,请返回消息页重连")},handleMsg:function(t){this.$nextTick(function(){this.scrollToView="msg"+t.id})},getCurTime:function(){var t=new Date,e=t.getFullYear(),s=this.dateFormat(t.getMonth()+1),i=this.dateFormat(t.getDate()),a=this.dateFormat(t.getHours()),n=this.dateFormat(t.getMinutes()),o=this.dateFormat(t.getSeconds());return"".concat(e,"-").concat(s,"-").concat(i," ").concat(a,":").concat(n,":").concat(o)},dateFormat:function(t){var e=Number(t);return e>=10?e+"":"0"+e},getChatHistory:function(){var t=this,e={type:"history",to_id:t.toId};t.socketObj.send({data:JSON.stringify(e),success:function(t){},fail:function(t){},complete:function(t){}})},getMsg:function(){var t=this;t.socketObj.onMessage(function(e){var s=JSON.parse(e.data);if("history"===s.type){var i=s.history?s.history:[];i.length>0&&(i.map(function(e,s,i){e.from_id==t.meId?(i[s]["type"]="me",i[s]["header"]=t.meHead):(i[s]["type"]="user",i[s]["header"]=t.userHead),i[s]["id"]=s,i[s]["msg"]=e.content,i[s]["date"]=e.time}),t.msgList=i,t.handleMsg(t.msgList[t.msgList.length-1]))}else if("one"===s.type){var a=s.message;if(a.from_id==t.toId){var n=t.msgList.length;t.msgList.push({type:"user",header:t.userHead,id:n,msg:a.content,date:a.time}),t.handleMsg(t.msgList[t.msgList.length-1])}}})}}};e.default=l}).call(this,s("6e42")["default"])},b297:function(t,e,s){"use strict";var i=s("c341"),a=s.n(i);a.a},c341:function(t,e,s){}},[["0338","common/runtime","common/vendor"]]]);